<<<<<<< HEAD
import * as crypto from 'node:crypto';
import { promisify } from 'node:util';
=======
import * as crypto from 'crypto';
import { promisify } from 'util';
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
import nodeDigest from './dsa_digest.js';
import nodeKey from './node_key.js';
import sign from './sign.js';
import getVerifyKey from './get_sign_verify_key.js';
<<<<<<< HEAD
const oneShotVerify = promisify(crypto.verify);
const verify = async (alg, key, signature, data) => {
    const k = getVerifyKey(alg, key, 'verify');
    if (alg.startsWith('HS')) {
        const expected = await sign(alg, k, data);
=======
import { oneShotCallback } from './flags.js';
let oneShotVerify;
if (crypto.verify.length > 4 && oneShotCallback) {
    oneShotVerify = promisify(crypto.verify);
}
else {
    oneShotVerify = crypto.verify;
}
const verify = async (alg, key, signature, data) => {
    const keyObject = getVerifyKey(alg, key, 'verify');
    if (alg.startsWith('HS')) {
        const expected = await sign(alg, keyObject, data);
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
        const actual = signature;
        try {
            return crypto.timingSafeEqual(actual, expected);
        }
        catch {
            return false;
        }
    }
    const algorithm = nodeDigest(alg);
<<<<<<< HEAD
    const keyInput = nodeKey(alg, k);
=======
    const keyInput = nodeKey(alg, keyObject);
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
    try {
        return await oneShotVerify(algorithm, data, keyInput, signature);
    }
    catch {
        return false;
    }
};
export default verify;
