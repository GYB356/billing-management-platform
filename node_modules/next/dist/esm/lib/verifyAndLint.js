import { red } from "./picocolors";
<<<<<<< HEAD
import { Worker } from "next/dist/compiled/jest-worker";
=======
import { Worker } from "./worker";
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
import { existsSync } from "fs";
import { join } from "path";
import { ESLINT_DEFAULT_DIRS } from "./constants";
import { eventLintCheckCompleted } from "../telemetry/events";
import { CompileError } from "./compile-error";
import isError from "./is-error";
export async function verifyAndLint(dir, cacheLocation, configLintDirs, enableWorkerThreads, telemetry) {
<<<<<<< HEAD
    try {
        const lintWorkers = new Worker(require.resolve("./eslint/runLintCheck"), {
=======
    let lintWorkers;
    try {
        lintWorkers = new Worker(require.resolve("./eslint/runLintCheck"), {
            exposedMethods: [
                "runLintCheck"
            ],
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
            numWorkers: 1,
            enableWorkerThreads,
            maxRetries: 0
        });
<<<<<<< HEAD
        lintWorkers.getStdout().pipe(process.stdout);
        lintWorkers.getStderr().pipe(process.stderr);
=======
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
        const lintDirs = (configLintDirs ?? ESLINT_DEFAULT_DIRS).reduce((res, d)=>{
            const currDir = join(dir, d);
            if (!existsSync(currDir)) return res;
            res.push(currDir);
            return res;
        }, []);
<<<<<<< HEAD
        const lintResults = await lintWorkers.runLintCheck(dir, lintDirs, {
=======
        const lintResults = await (lintWorkers == null ? void 0 : lintWorkers.runLintCheck(dir, lintDirs, {
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
            lintDuringBuild: true,
            eslintOptions: {
                cacheLocation
            }
<<<<<<< HEAD
        });
=======
        }));
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
        const lintOutput = typeof lintResults === "string" ? lintResults : lintResults == null ? void 0 : lintResults.output;
        if (typeof lintResults !== "string" && (lintResults == null ? void 0 : lintResults.eventInfo)) {
            telemetry.record(eventLintCheckCompleted({
                ...lintResults.eventInfo,
                buildLint: true
            }));
        }
        if (typeof lintResults !== "string" && (lintResults == null ? void 0 : lintResults.isError) && lintOutput) {
            await telemetry.flush();
            throw new CompileError(lintOutput);
        }
        if (lintOutput) {
            console.log(lintOutput);
        }
<<<<<<< HEAD
        lintWorkers.end();
=======
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
    } catch (err) {
        if (isError(err)) {
            if (err.type === "CompileError" || err instanceof CompileError) {
                console.error(red("\nFailed to compile."));
                console.error(err.message);
                process.exit(1);
            } else if (err.type === "FatalError") {
                console.error(err.message);
                process.exit(1);
            }
        }
        throw err;
<<<<<<< HEAD
=======
    } finally{
        try {
            lintWorkers == null ? void 0 : lintWorkers.end();
        } catch  {}
>>>>>>> 4f9d35bd5c5bf095848f6fc99f7e7bfe5212365f
    }
}

//# sourceMappingURL=verifyAndLint.js.map